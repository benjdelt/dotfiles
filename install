#!/usr/bin/env bash

readonly BACKUP_DIR=~/dotfiles/home_backup/
readonly IGNORE=(.git .gitignore .swp$)
readonly SCRIPT_DIR=$(dirname "$0")

in_ignore () {
    for i in "${IGNORE[@]}"; do
	if [[ "$1" =~ $i ]]; then
            return 0
	fi
    done
    return 1
}

remove_existing_dir () {
    local basename
    basename=$(basename "$1")
    local target_dir=~/$basename
    if [[ -d $1 && -d $target_dir ]]; then
	echo "target $target_dir"
	rm -rf "$target_dir"
    fi
}
        
if [[ ! -d $BACKUP_DIR ]]; then
    mkdir -v $BACKUP_DIR
fi

cd "$(pwd)/$SCRIPT_DIR" || exit 1

if [[ "$?" -ne 0 ]]; then
    exit 1
fi

echo 'Backing up and creating links to dotfiles...'

for f in ./.[^.]*; do
    basename=$(basename "$f")
    in_ignore "$(basename "$f")"
    if [[ "$?" -ne 0 ]]; then
        rsync -rv --no-links "$HOME/$basename" $BACKUP_DIR
	remove_existing_dir "$f"
	ln -svf "$(pwd)/$basename" ~/
    fi
done

